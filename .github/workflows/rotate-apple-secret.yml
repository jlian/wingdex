name: Rotate Apple Client Secret

# Apple client secrets are JWTs signed with the .p8 private key.
# Max validity is 6 months; we rotate every 5 months for safety margin.
on:
  schedule:
    - cron: '0 9 1 */5 *'   # 09:00 UTC on the 1st of every 5th month
  workflow_dispatch:          # manual trigger for initial setup / emergency rotation

permissions:
  contents: read

jobs:
  rotate:
    name: Generate & deploy Apple client secret
    runs-on: ubuntu-latest
    steps:
      - name: Generate Apple client secret JWT
        id: jwt
        uses: actions/github-script@v7
        with:
          script: |
            const crypto = require('crypto');

            const teamId = process.env.APPLE_TEAM_ID;
            const clientId = process.env.APPLE_CLIENT_ID;
            const keyId = process.env.APPLE_KEY_ID;
            const privateKey = process.env.APPLE_PRIVATE_KEY;

            if (!teamId || !clientId || !keyId || !privateKey) {
              core.setFailed('Missing required Apple secrets (APPLE_TEAM_ID, APPLE_CLIENT_ID, APPLE_KEY_ID, APPLE_PRIVATE_KEY)');
              return;
            }

            const now = Math.floor(Date.now() / 1000);
            const exp = now + (6 * 30 * 24 * 60 * 60); // ~6 months

            const header = { alg: 'ES256', kid: keyId };
            const payload = {
              iss: teamId,
              iat: now,
              exp,
              aud: 'https://appleid.apple.com',
              sub: clientId,
            };

            function base64url(obj) {
              return Buffer.from(JSON.stringify(obj))
                .toString('base64url');
            }

            const headerB64 = base64url(header);
            const payloadB64 = base64url(payload);
            const signingInput = `${headerB64}.${payloadB64}`;

            const key = crypto.createPrivateKey(privateKey);
            const sig = crypto.sign('sha256', Buffer.from(signingInput), {
              key,
              dsaEncoding: 'ieee-p1363',
            });

            const clientSecret = `${signingInput}.${sig.toString('base64url')}`;
            core.setSecret(clientSecret);
            core.setOutput('client_secret', clientSecret);

            const expDate = new Date(exp * 1000).toISOString().slice(0, 10);
            core.info(`Generated Apple client secret (expires ${expDate})`);
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_CLIENT_ID: ${{ secrets.APPLE_CLIENT_ID }}
          APPLE_KEY_ID: ${{ secrets.APPLE_KEY_ID }}
          APPLE_PRIVATE_KEY: ${{ secrets.APPLE_PRIVATE_KEY }}

      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 25

      - name: Install wrangler
        run: npm install -g wrangler

      - name: Push secret to Cloudflare Pages (production)
        run: printf '%s' "$APPLE_CLIENT_SECRET" | npx wrangler pages secret put APPLE_CLIENT_SECRET --project-name=wingdex
        env:
          APPLE_CLIENT_SECRET: ${{ steps.jwt.outputs.client_secret }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Push secret to Cloudflare Pages (preview)
        run: printf '%s' "$APPLE_CLIENT_SECRET" | npx wrangler pages secret put APPLE_CLIENT_SECRET --project-name=wingdex --env preview
        env:
          APPLE_CLIENT_SECRET: ${{ steps.jwt.outputs.client_secret }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
